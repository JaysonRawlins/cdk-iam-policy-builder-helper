name: Dependabot Alerts to Issues

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual triggering

permissions:
  issues: write
  security-events: read

jobs:
  create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Get Dependabot alerts
        id: get-alerts
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            for (const alert of alerts.data) {
              // Check if issue already exists for this alert
              const issueTitle = `[Dependabot] ${alert.security_advisory.summary} in ${alert.dependency.package.name}`;
              
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependabot-alert',
                per_page: 100
              });

              const issueExists = existingIssues.data.some(issue => 
                issue.title === issueTitle
              );

              if (!issueExists) {
                const severity = alert.security_advisory.severity;
                const cvss = alert.security_advisory.cvss.score;
                const description = alert.security_advisory.description;
                const recommendation = alert.security_vulnerability.first_patched_version?.identifier || 'No patch available';

                const issueBody = `
            ## Security Alert: ${alert.security_advisory.summary}

            **Package:** \`${alert.dependency.package.name}\`
            **Current Version:** \`${alert.security_vulnerability.vulnerable_version_range}\`
            **Severity:** ${severity} (CVSS: ${cvss})
            **CVE:** ${alert.security_advisory.cve_id || 'N/A'}

            ### Description
            ${description}

            ### Recommendation
            ${recommendation !== 'No patch available' ? `Update to version \`${recommendation}\` or later` : recommendation}

            ### References
            ${alert.security_advisory.references.map(ref => `- ${ref.url}`).join('\n')}

            ---
            [View alert in GitHub](${alert.html_url})
            `;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['dependabot-alert', 'security', severity.toLowerCase()]
                });

                console.log(`Created issue for alert: ${issueTitle}`);
              }
            }